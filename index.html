<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Notas por CPF (Seguro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Consulta de Desempenho Escolar</h1>
            <p class="text-gray-500 mt-2">Mestre Leal, digite seu CPF para verificar sua situa√ß√£o e m√©dia de forma segura.</p>
        </header>

        <div class="space-y-4">
            <label for="cpfInput" class="block text-sm font-medium text-gray-700">CPF do Aluno (Apenas n√∫meros)</label>
            <input
                type="text"
                id="cpfInput"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg transition duration-150"
                placeholder="Ex: 908.172.815-68"
                maxlength="14"
                oninput="formatCPF(this)"
            >

            <button
                onclick="searchStudent()"
                class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50"
            >
                Consultar Dados
            </button>
        </div>

        <div id="resultsArea" class="hidden mt-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Resultado da Consulta:</h2>
            <div id="resultCard" class="p-5 rounded-xl shadow-inner transition-all duration-300">
                </div>
        </div>

        <div id="messageArea" class="hidden p-4 rounded-lg text-center font-medium">
            </div>

    </div>

    <script>
        // üö® NOVO: URL do Apps Script para comunica√ß√£o segura.
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4IZXsOQfQVUAN4G-OVcCr4dggvVGnJqmYYOiOVefKPmVEfCdwUrGAUZNoy2y-Z1zc/exec';
        
        // REMOVIDO: A lista const studentData foi removida daqui para proteger os dados!

        const resultsArea = document.getElementById('resultsArea');
        const resultCard = document.getElementById('resultCard');
        const messageArea = document.getElementById('messageArea');

        // Fun√ß√£o para formatar o CPF (visual)
        function formatCPF(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);

            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d{3})$/, '$1');
            }

            input.value = value;
        }

        // Fun√ß√£o principal para buscar o aluno (agora chama o Apps Script)
        async function searchStudent() {
            const cpfInput = document.getElementById('cpfInput');
            // Remove a m√°scara (pontos e tra√ßos) e espa√ßos para a busca
            const cleanedCpf = cpfInput.value.replace(/[^\d]/g, '').trim();

            resultsArea.classList.add('hidden');
            messageArea.classList.add('hidden');
            resultCard.innerHTML = '';
            messageArea.innerHTML = '';

            if (cleanedCpf.length !== 11) {
                showMessage('Por favor, digite um CPF v√°lido com 11 d√≠gitos.', 'bg-yellow-100 text-yellow-800 border-yellow-300');
                return;
            }

            try {
                // Requisi√ß√£o POST segura para o Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cpf: cleanedCpf })
                });

                if (!response.ok) {
                    throw new Error('Falha na comunica√ß√£o com o Apps Script.');
                }

                const data = await response.json();

                if (data.nome) { // Se o Apps Script retornou o objeto do aluno
                    displayResults(data);
                } else { // Se o aluno n√£o foi encontrado ou erro retornado pelo script
                    showMessage('CPF n√£o encontrado ou houve um erro interno. Verifique o n√∫mero.', 'bg-red-100 text-red-800 border-red-300');
                }

            } catch (error) {
                console.error('Erro de consulta:', error);
                showMessage('Ocorreu um erro de rede ou conex√£o. Tente novamente.', 'bg-gray-100 text-gray-700 border-gray-300');
            }
        }

        // Fun√ß√£o para exibir mensagens de erro/alerta
        function showMessage(message, classes) {
            messageArea.innerHTML = `<p>${message}</p>`;
            messageArea.className = `p-4 rounded-lg text-center font-medium border ${classes}`;
            messageArea.classList.remove('hidden');
        }

        // Fun√ß√£o para exibir os dados do aluno encontrado
        function displayResults(student) {
            const isApproved = student.resultado && student.resultado.toUpperCase() === 'APROVADO';

            const statusColor = isApproved ? 'bg-green-600' : 'bg-red-600';
            const cardClasses = isApproved ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50';
            const icon = isApproved ? '‚úÖ' : '‚ùå';

            resultCard.className = `p-5 rounded-xl shadow-xl transition-all duration-300 border-2 ${cardClasses}`;

            resultCard.innerHTML = `
                <div class="space-y-4">
                    <p class="text-xl font-bold text-gray-900 uppercase">${student.nome}</p>

                    <div class="flex items-center space-x-3 p-3 rounded-lg ${statusColor} text-white shadow-lg">
                        <span class="text-2xl">${icon}</span>
                        <span class="text-xl font-semibold">Situa√ß√£o: ${student.resultado || 'N/A'}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-gray-700">
                        <div>
                            <p class="text-sm font-medium text-gray-500">CPF (limpo)</p>
                            <p class="text-lg font-semibold">${student.cpf}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">M√©dia Final</p>
                            <p class="text-lg font-semibold">${student.media ? parseFloat(student.media).toFixed(1) : 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
            resultsArea.classList.remove('hidden');
        }

        // Inicializa o Listener para a tecla Enter
        document.getElementById('cpfInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchStudent();
            }
        });

    </script>

</body>
</html>
